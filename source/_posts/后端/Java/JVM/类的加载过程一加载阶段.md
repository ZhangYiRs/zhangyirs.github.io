---
title: 类的加载过程一加载阶段
p: 后端/Java/JVM/类的加载过程一加载阶段
date: 2021-08-26 19:44:20
tags: [Java,JVM,类的生命周期]
categories: [Java,JVM,类的生命周期]
---
## 过程一：Loading（加载）阶段

### 1. 加载完成的操作

> 加载的理解：所谓加载，就是将Java类的字节码文件加载到机器内存中，并在内存中构建出Java类的原型————类模板对象。

类模板对象：Java类在JVM内存中的一个快照，JVM将从字节码文件中解析出的常量池、类字段、类方法等信息存储到类模板中，这样JVM在运行期便能通过类模板而获取Java类中的任意信息，能够对Java类的成员变量进行便利，也能进行Java方法的调用。
反射的机制基于这一基础。如果JVM没有将Java类的声明信息存储起来，则JVM在运行期也无法反射。

加载完成的操作

加载阶段，简言之，查找并加载类的二进制数据，生成Class的实例。
在加载类时，Java虚拟机必须完成以下3件事情：

- 通过类的全名，获取类的二进制数据流。
- 解析类的二进制数据流为方法区内的数据结构（Java类模型）
- 创建java.lang.Class类的实例，表示该类型。作为方法区这个类的各种数据的访问入口

### 2. 二进制流的获取方式

对于类的二进制数据流，虚拟机可以通过多种途径产生或获得(只要所读取的字节码符合JVM规范即可)

- 虚拟机可能通过文件系统读入一个class后缀的文件（最常见）
- 读入jar、zip等归档数据包，提取类文件。
- 实现存放在数据库中的类的二进制数据
- 使用类似于HTTP之类的协议通过网络进行加载
- 在运行时生成一段Class的二进制信息等

在获取到类的二进制信息后，Java虚拟机就会处理数据，并最终转为一个java.lang.Class的实例

如果输入数据不是ClassFile的结构，则会抛出ClassFormatError。

### 3. 类模型与Class实例的位置

1. 类模型的位置：方法区（JDK1.8之前：永久代，JDK1.8及之后：元空间）
2. Class实例的位置： 类将.class文件加载至元空间后，会在堆中创建一个Java.lang.Class对象，用来封装类位于方法区内的数据结构，该Class对象是在加载类的过程中创建的。每个类都对应有一个Class类型的对象。
3. Class类的构造方法是私有的，只有JVM能够创建

### 4. 数组类的加载

创建数组类的情况有些特殊，因为数组类本身并不是由类加载器负责创建，而是由JVM在运行时根据需要而直接创建的，但数组的元素类型仍然需要依靠类加载器区创建。创建数组类（下述简称A）的过程：

1. 如果数组的元素类型是引用类型，那么就遵循定义的加载过程递归加载和创建数组A的元素类型；
2. JVM使用指定的元素类型和数组未读来创建新的数组类。

如果数组的元素类型是引用类型，数组类的可访问性就由元素类型的可访问性决定。否则数组类的可访问性将被缺省定义为public