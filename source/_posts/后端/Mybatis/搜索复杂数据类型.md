---
title: 搜索复杂数据类型
date: 2020-11-13 16:25:32
tags: Maybatis
categories: Maybatis
---

## Insert之后返回自增主键

### mapper.xml

```sql
<insert id="insertScript" useGeneratedKeys="true" keyProperty="script.id" keyColumn="id">
INSERT INTO merchant_script(script_desc, tips, name, cover_oss_url, difficulty, role_num)
VALUE (#{script.desc}, #{script.tips}, #{script.name}, #{script.img}, #{script.difficulty},#{script.roleNum});
</insert>
```

### dao.java

```java
Integer insertScript(@Param("script") ScriptDto script);
```

### 实体类

实体类不需要进行特殊处理

### 例子

```java
ScriptDto scriptDto = new ScriptDto();
scriptDao.insertScript(scriptDto);
return new ScriptAddRespVo().setId(scriptDto.getId());
```

声明个空的实体类，在insert之后可以自动获取id
**注意：insert的返回值是插入的行数，不是id！！！！！**

## select复杂的数据结构

可以对象中套list，再套对象
**注意如果collection中的column在sql中没有会报错，所以这个复用性不是很好**

```sql
<resultMap id="merchantResultMap" type="com.mega.scriptkill.merchant.controller.dto.MerchantDto">
    <id column="id" property="id"/>
    <result column="distance" property="location.distance"/>
    <result column="name" property="name"/>
    <result column="address" property="location.address"/>
    <result column="name" property="name"/>
    <collection property="tagList" ofType="String">
        <constructor>
            <arg column="tag_name"/>
        </constructor>
    </collection>
    <collection property="imgList" ofType="String">
        <constructor>
            <arg column="img_url"/>
        </constructor>
    </collection>
</resultMap>

<select id="getMerchant" resultMap="merchantResultMap">
    SELECT
    <if test="merchantSearchCondition.latitude!=null and merchantSearchCondition.longitude!=null">
    ma.distance AS distance,
    </if>
    m.id AS id, m.merchant_name AS name, ma.address AS address, mpt.tag_desc AS tag_name,
    mp.oss_url AS img_url
    FROM merchant AS m
    LEFT JOIN (SELECT *,ROUND(6378.138 * 2 * ASIN(SQRT(POW(SIN((#{merchantSearchCondition.latitude} * PI() / 180 - ma.latitude * PI() / 180) / 2),
    2) +
    COS(#{merchantSearchCondition.latitude} * PI() / 180) * COS(ma.latitude * PI() / 180) *
    POW(SIN((#{merchantSearchCondition.longitude} * PI() / 180 - ma.longitude * PI() / 180) / 2), 2))) *
    1000) AS distance FROM merchant_address AS ma) ma ON ma.merchant_id = m.id and ma.delsign = 0
    LEFT JOIN merchant_tag mt ON mt.merchant_id = m.id AND mt.delsign = 0
    LEFT JOIN merchant_public_tag mpt on mt.tag_id = mpt.id AND mpt.delsign = 0
    LEFT JOIN merchant_picture mp on mp.merchant_id = m.id AND mp.delsign = 0
    <if test="merchantSearchCondition.scriptId != null and merchantSearchCondition.scriptId != 0">
    LEFT JOIN merchant_script_ref msr on m.id = msr.merchant_id AND msr.delsign = 0
    </if>
    WHERE m.delsign = 0 AND m.status = 10
    <if test="merchantSearchCondition.name!=null">
    AND m.merchant_name like concat('%',#{merchantSearchCondition.name},'%')
    </if>
    <if test="merchantSearchCondition.cityCode!=null">
    AND ma.city_code = #{merchantSearchCondition.cityCode}
    </if>
    <if test="merchantSearchCondition.distance!=null and merchantSearchCondition.geohashList!=null">
    AND ma.distance > #{merchantSearchCondition.lastId} AND #{merchantSearchCondition.distance} > ma.distance
    AND ma.geohash IN
    <foreach collection="merchantSearchCondition.geohashList" item="item" separator="," open="(" close=")">
        #{item}
    </foreach>
    </if>
    <if test="merchantSearchCondition.scriptId != null and merchantSearchCondition.scriptId != 0">
    AND msr.script_id = #{merchantSearchCondition.scriptId}
    </if>
    <if test="merchantSearchCondition.longitude == null and merchantSearchCondition.latitude == null and merchantSearchCondition.lastId != null and merchantSearchCondition.lastId != 0">
    AND #{merchantSearchCondition.lastId} > m.id
    </if>

    <if test="merchantSearchCondition.longitude != null and merchantSearchCondition.latitude != null">
    ORDER BY ma.distance , m.id DESC
    </if>
    <if test="merchantSearchCondition.longitude == null and merchantSearchCondition.latitude == null">
    ORDER BY m.id DESC
    </if>
    <if test="merchantSearchCondition.limit != null">
    LIMIT #{merchantSearchCondition.limit}
    </if>
</select>
```

当resultType的映射类是内部类时不能用点需要用$符号

```sql
<select id="getUserInfo" resultType="com.mega.werewolf.cloud.jp.hang.vo.HangEventGetVO$Friend">
    SELECT t.no                 AS id,
            t.nickname           AS `name`,
            IFNULL(ti.sex, 0)    AS sex,
            th.content           AS content,
            t.headicon           AS headIcon,
            IFNULL(t.frame, '0') AS frame,
            IFNULL(uex.level, 1) AS `level`,
            t.bug                AS tag
    FROM tuser as t
                LEFT JOIN tuser_info ti ON t.no = ti.userno
                LEFT JOIN tuser_hang th ON t.no = th.user_id
                LEFT JOIN user_exp uex ON t.`no` = uex.user_id AND uex.exp_id = 1
    WHERE t.no = #{friendId}
</select>
```