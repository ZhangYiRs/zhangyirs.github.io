---
title: 锚点树
p: Vue/锚点树
date: 2019-12-08 10:17:43
tags: [Vue,JS,锚点树]
categories: [前端,Vue,锚点树]
---
## 锚点树

{% asset_img mds.png  锚点树 %}
通过右侧的滚轮滚动，激活左侧目录，同时点击左侧目录右侧滚动

`锚点树代码`

```vue
<template>
  <div class="time-line">
    <div v-for="(item,index) in array"  :key="index" class="time-item" :id="'timeline' + index" @click="scrolljump(item.fname)">
      <!--点-->
      <div class="time-item-point">
        <div class="time-item-point-img"  :class="active(item.fname)"></div>
        <div :class="index===array.length-1?'':'time-item-line'"></div>
      </div>
      <div class="time-item-point-word" :class="cancel(item.fname)">{{item.fname}}</div>
      <!--线-->
    </div>
  </div>
</template>

<script>
  export default {
    name: 'mds',
    props: {
      array: Array,
      activeSzxx: Array,
      scrollHeight: Number
    },
    data() {
      return {
        activeIndex: '',
        arrayCancel: [],
        scrollActive: []
      }
    },
    created() {
      this.copyArray(this.activeSzxx)
    },
    mounted() {
      this.setScrollActive()
    },
    watch: {
      activeSzxx: {
        handler(newVal, oldVal) {
          this.arrayCancel = []
          this.copyArray(newVal)
        },
        deep: true
      },
      scrollHeight(newVal, oldVal) {
        // 将变更的滚轮高度限和边界值比较
        if (this.scrollActive.length === 0) {
          this.setScrollActive()
        }
        for (var i = 0; i < this.scrollActive.length; i++) {
          if (newVal >= this.scrollActive[i].height && newVal < this.scrollActive[i + 1].height) {
            // 激活activeIndex
            this.activeIndex = this.scrollActive[i].fname
            break
          }
        }
      }
    },
    computed: {
      active() {
        return function(fname) {
          if (this.activeIndex === fname && this.cancel(fname) !== 'cancel') {
            return 'activetime'
          }
        }
      },
      cancel() {
        return function(fname) {
          var count = 0
          for (var i = 0; i < this.arrayCancel.length; i++) {
            if (this.arrayCancel[i] === fname) {
              count++
              break
            }
          }
          if (count !== 1) {
            return 'cancel'
          }
        }
      }
    },
    methods: {
      setScrollActive() {
        var j = 0
        for (var i = 0; i < this.arrayCancel.length; i++) {
          while (j < this.activeSzxx.length) {
            if (this.arrayCancel[i] === this.activeSzxx[j].fname) {
              let ele = document.getElementById(this.activeSzxx[j].id + 'pz')
              let height = ele.offsetTop ? ele.offsetTop - 130 : 0
              this.scrollActive.push({
                'height': height,
                'fname': this.arrayCancel[i]
              })
            } else {
              break
            }
            j++
          }
        }
      },
      scrolljump(fname) {
        this.activeIndex = fname
        // 传给父组件类别
        this.$root.$emit('fname', fname)
      },
      copyArray(arr) {
        for (var i = 0; i < arr.length; i++) {
          if (this.arrayCancel.indexOf(arr[i].fname) === -1) {
            this.arrayCancel.push(arr[i].fname)
          }
        }
      }
    }
  }
</script>

<style scoped>
  .time-line{
    position: relative;
    cursor: pointer;
    height: 571px;
    background-color: #edf7f9;
    border: 2px dashed #C9DAEB;
    border-radius: 5px;
    padding: 10px;
    font-size: 14px;
    overflow:scroll
  }
  .time-item{
    position: relative;
    width: 100%;
    height: 40px;
  }
  .time-item-point{
    position: absolute;
    top: 8px;
    width: 10px;
    height: 40px;
    display: inline-block;
  }
  .time-item-point-img{
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 100px;
    background-color: #C9DAEA;
    opacity: 0.5;
    display: inline-block;
  }
  .time-item-point-img.activetime{
    left: -2px;
    width: 10px;
    height: 10px;
    background-color: #1E9DFF;
  }
  .time-item-point-word{
    width: 260px;
    height: 40px;
    text-align: left;
    position: absolute;
    left: 15px;
    display: inline-block;
  }
  .time-item-point-word.cancel{
    color: #C5D2E5;
  }
  .time-item-line{
    position: absolute;
    top: 12px;
    height: 30px;
    width: 3px;
    border-right: 1px dashed #C9DAEA;
  }
</style>
```

props：中三个属性的含义：

- array：左侧目录数据
- activeSzxx: 右侧所有数据，数据中需要包含左侧分类名称也就是fname
- scrollHeight: 右侧滚动条距离顶部高度，也就是scrollTop

`弹窗代码`

```js
<template>
  <div class="dialog fd-pic-pstil" pzyl pzylwbpz>
    <el-row style="flex:1">
      <el-col :span="8">
        <mds2 :array="PDF_SELECT" :activeSzxx="postilList" :scrollHeight2='scroll2'></mds2>
      </el-col>
      <el-col :span="16" class="checkBox">
        <el-checkbox v-model="checkAll" @change="handleCheckAllChange" class="select_all">全选</el-checkbox>
        <el-checkbox-group id="checkboxGroup" v-model="checkedCities" @change="handleCheckedCitiesChange" class="right_group2">
        <pzitem v-for="item in postilList" :pzdata='item' :key="item.id" @del='del' :id="item.id + 'pz'">
          <template slot="checkbox">
            <el-checkbox :label="item.id" class="checkboxwrap"></el-checkbox>
          </template>
        </pzitem>
      </el-checkbox-group>
      </el-col>
    </el-row>
    <el-row class="content_btn_box">
      <el-button type="primary" @click="confirmExport()" class='fd-export-ppt'>导出ppt</el-button>
    </el-row>
  </div>

</template>
<script>
  import pzitem from './postilItem'
  import Bus from 'src/views/publicJs/bus.js'
  import api from 'src/api'
  import $ from 'jquery'
  import mds2 from './mds2.vue'
  import annotationType from '../../../static/annotationType/annotationType'

  export default {
    components: {
      pzitem,
      mds2
    },
    data() {
      return {
        postilList: [],
        isShowTools: false,
        checkedCities: [],
        showSzms: true, // 展示示证模式工具栏
        caseId: this.$route.params.caseId,
        caseNumber: window.localStorage.getItem('caseNumber'),
        tysah: window.localStorage.getItem('tysah'),
        config: {
          initialFrameWidth: null,
          initialFrameHeight: window.innerHeight * 0.73
        },
        templateInfo: '',
        // jpgUrl: '',
        szxx: [],
        szxxId: '',
        enable: true,
        inputSize: {
          minRows: '2',
          maxRows: '2'
        },
        showDialog: false, // 截图放大展示
        imgUrl: '',
        imgWidth: '400px',
        imgTitle: '',
        szxxSelectedList: [], // 选中的示证id数组集合
        szxxSelectedListTemp: [], // 用来全选功能
        dcPPTShow: false, // 控制是否展示到处PPT样式
        isIndeterminate: true,
        checkAll: true, // 控制全选
        showDcPPTStyle: false, // 控制是否展示导出样式
        PDF_SELECT: [],
        scroll2: 0
      }
    },
    computed: {
      zjmc() {
        return this.$store.state.evidenceName
      },
      ym() {
        return this.$store.state.evidencePage
      },
      wsbh() {
        return this.$store.state.currentTreeId
      }
    },
    mounted() {
      this.$root.$on('fname2', (index) => {
        for (var i = 0; i < this.postilList.length; i++) {
          var tz = this.postilList[i]
          if (index === tz.fname) {
            let ele = document.getElementById(tz.id + 'pz')
            let height = ele.offsetTop - 30
            $('#checkboxGroup').animate({scrollTop: height}, 300)
            this.$store.commit('setCurrentClickTppz', this.postilList[i].id)
            break
          }
        }
      })
      this.$root.$on('initData', () => {
        this.initData()
      })
      document.querySelector('.right_group2').addEventListener('scroll', this.scrollMenu)
    },
    created() {
      this.PDF_SELECT = annotationType.data.typeList
      this.initData()
      this.$root.$on('setZjmcYm', (zjmc, ym) => {
        this.zjmc = zjmc
        this.ym = ym
      })
      this.$root.$on('isShowSzms', (val) => {
        this.showSzms = val
      })
      // this.$root.$on('addSzzj', (val) => {
      //   this.addSzzj(val)
      // })
      this.$root.$on('exportPPTShow', () => {
        this.showExportPPTShow()
      })
      this.$root.$on('exportPPTHidden', () => {
        this.cancelExport()
      })
    },
    methods: {
      scrollMenu() {
        this.scroll2 = Number(document.querySelector('.right_group2').scrollTop)
        console.log(this.scroll2)
      },
      handleCheckedCitiesChange(value) {
        this.checkAll = value.length === this.postilList.length
      },
      handleCheckAllChange(value) {
        if (value) {
          this.postilList.forEach(element => {
            this.checkedCities.push(element.id)
          })
        } else {
          this.checkedCities = []
        }
      },
      del(id) {
        this.deletePost(id)
        let index = ''
        this.postilList.forEach((element, i) => {
          if (element.id === id) {
            index = i
          }
        })
        this.postilList.splice(index, 1)
      },
      showShotTools() {
        this.isShowTools = true
        $('#yjScreenShot').click()
      },
      closePages() {
        this.$root.$emit('closeSzzj', false)
        this.showSzms = false
        this.$nextTick(() => {
          this.$root.$emit('resetShot')
        })
        Bus.$emit('showtext', '0')
      },
      deletePost(id) {
        // 删除
        var param = {
          szxxId: id
        }
        api.post('/deleteSzms', param, {}).then(response => {
          if (response.status === 204 | response.status === 200) {
            if (response.data) {
              this.$message({
                message: '删除成功',
                type: 'success'
              })
              // this.initData()
            } else {
              this.$message({
                message: '删除失败，请重新尝试或联系管理员',
                type: 'warning'
              })
            }
          }
        }, err => {
          this.$message({
            message: '查询失败，请重新尝试或联系管理员',
            type: 'warning'
          })
          console.log(err)
        })
      },
      changeName(arg, index) {
        if (this.szxx[index].id) {
          this.save(this.szxx[index])
        }
      },
      showCapture(url, wsName) {
        let img = new Image()
        img.src = url
        img.onload = () => {
          let width = img.width < 200 ? 200 : img.width
          this.imgWidth = width + 30 + 'px'
          this.imgUrl = url
          this.imgTitle = wsName
          this.showDialog = true
        }
      },
      showDialogF() {
        this.showDialog = true
      },
      showEnlargeIcon(item) {
        this.$set(item, 'enlargeIcon', true)
      },
      closeEnlargeIcon(item) {
        this.$set(item, 'enlargeIcon', false)
      },
      initData() {
        var param = {}
        return api.get('/pz/pzyl/' + this.caseId + '/2', param, {}).then(response => {
          if (response.status === 204 || response.status === 200) {
            this.postilList = response.data
            this.sort(this.postilList)
            this.handleCheckAllChange(true)
            this.initCheckBox()
            this.postilList.forEach((item, index) => {
              this.$set(item, 'enlargeIcon', false)
            })
          }
        }, err => {
          this.$message({
            message: '查询失败，请重新尝试或联系管理员',
            type: 'warning'
          })
          console.log(err)
        })
      },
      sort(list) {
        for (var i = 0; i < list.length; i++) {
          for (var j = 0; j < this.PDF_SELECT.length; j++) {
            if (list[i].fname === this.PDF_SELECT[j].fname) {
              this.$set(list[i], 'fid', this.PDF_SELECT[j].fid)
            }
          }
        }
        list.sort(function (a, b) {
          return Number(a.fid) < Number(b.fid) ? -1 : 1
        })
        return list
      },
      save(item) {
        var param = {}
        Object.assign(param, item)
        return api.post('/saveContent', param, {}).then(response => {
          if (response.status === 204 | response.status === 200) {
            if (this.szxxSelectedList.indexOf(response.data) === -1) {
              this.szxxSelectedList.push(response.data)
            }
            if (this.szxxSelectedListTemp.indexOf(response.data) === -1) {
              this.szxxSelectedListTemp.push(response.data)
            }
            this.$message({
              message: '保存成功',
              type: 'success'
            })
            return response.data
          }
        }, err => {
          this.$message({
            message: '保存失败，请重新尝试或联系管理员',
            type: 'warning'
          })
          console.log(err)
        })
      },
      /**
       * 点击页码跳转对应的文书
       */
      toWsBybh(item) {
        this.$root.$emit('wsbh', item.wsbh)
        this.$root.$emit('changeTreeSelect', item.wsbh)
        this.$store.commit('setEvidenceName', item.wsName.split('-')[0])
        this.$store.commit('setEvidencePage', item.wsName.split('-')[1])
      },
      /**
       * 显示编辑示证内容方法
       */
      editSznr(index) {
        // this.szxx[index].showEditorSznr = true
        this.$set(this.szxx[index], 'showEditorSznr', true)
      },
      /**
       * 编辑示证内容失去焦点实时保存方法
       */
      pinkUpLoseFocus(index) {
        // TODO保存示证内容
        this.szxx[index].showEditorSznr = false
        if (this.szxx[index].id) {
          this.save(this.szxx[index])
        }
      },
      /**
       * 清空示证内容
       */
      clearSznr(index) {
        this.szxx[index].sznr = ''
      },
      /**
       * 截图鼠标松开，自动添加示证证据的方法
       * @param {String} imagData 图片的base64码
       */
      addSzzj(pzData) {
        // 增加示证证据
        // this.szxx.forEach((item, index) => {
        //   item.show = true
        // })
        let szxxItem = {}
        // szxxItem.id = this.globel.util.newId()
        szxxItem.ajbh = this.caseId // '4F2B6816E90C454280DFAB61FA0857AE' // this.caseId,
        szxxItem.bmsah = this.caseNumber // '修检起诉受[2014]52012300069号' // this.caseNumber,
        szxxItem.tysah = '' // this.tysah,
        // szxxItem.szbt = `示证证据分类${this.szxx.length + 1}`
        szxxItem.szbt = pzData.code
        szxxItem.wsName = `${this.zjmc}-${this.ym}`
        // szxxItem.ym = this.ym
        szxxItem.pic = pzData.dataURL
        szxxItem.sznr = pzData.text
        szxxItem.wsbh = this.wsbh
        szxxItem.showEditorSznr = true
        this.szxx.push(szxxItem)
        this.$nextTick(() => {
          $('#szmsContent').scrollTop($('#szmsContent')[0].scrollHeight)
          // $('#sznr' + (this.szxx.length - 1)).focus() // 获取焦点
        })
        this.save(szxxItem).then(result => {
          szxxItem.id = result
        })
      },
      // 初始化选中数组
      initCheckBox() {
        this.szxx.forEach(element => {
          this.szxxSelectedList.push(element.id)
          this.szxxSelectedListTemp.push(element.id)
        })
      },
      // 全选功能
      // handleCheckAllChange(val) {
      //   this.szxxSelectedList = val ? this.szxxSelectedListTemp : []
      //   this.isIndeterminate = false
      // },
      // 展示导出PPT样式
      showExportPPTShow() {
        if (this.$store.state.isShotModal) {
          this.$message({
            message: '请先取消截图状态',
            type: 'warning'
          })
          return
        }
        this.showDcPPTStyle = true
        this.szxxSelectedList = this.szxxSelectedListTemp
        this.isIndeterminate = true
      },
      cancelExport() {
        this.showDcPPTStyle = false
      },
      // 导出选中的图片批注至PPT
      confirmExport() {
        if (this.checkedCities.length === 0) {
          this.$message({
            message: '请至少选择一个图片批注',
            type: 'warning'
          })
          return
        }
        let uri = '/rest/v4/exportPPT/' + this.caseId + '/' + this.checkedCities
        window.location.href = window.location.protocol + '//' + window.location.host + uri
        this.showDcPPTStyle = false
      }
    }
  }
</script>
<style lang='less'>
  .fd-dialog-pic .el-dialog__body{
    padding-bottom: 0;
  }
  .fd-pic-pstil{
    padding-bottom: 79px;
    position: relative;
    overflow: visible !important;
  }
  div[pzylwbpz] {
    display: flex;
    max-height: 652px;
    overflow: hidden;
    .select_all {
        margin-left: 2.5%;
        padding-left: 5px;
        .el-checkbox__label {
          font-weight: bold;
        }
      }
    .fd-left {
      width: 30%;
      height: 100%;
    }
    .el-checkbox__input.is-checked .el-checkbox__inner {
        background: #00a1a8;
        border-color: #00a1a8;
      }

      .right_group2 {
        font-size: 14px;
        max-height: 549px;
        overflow: auto;
        padding: 0 0 10px 0;
      }
      .checkboxwrap {
        position: absolute;
        left: 5px;
        top: -2px;
        .el-checkbox__label {
          display: none;
        }
      }
      .content_btn_box {
        position: absolute;
        bottom: 0px;
        right: -15px;
        padding:15px 15px 15px 0;
        width: calc(~"100% + 30px");
        height: 64px;
        text-align: right;
        background: #edf1fa;
        z-index:10;
        border-radius: 5px;
        .fd-export-ppt{
          background: url('../../assets/sidebar/4_05.png') no-repeat center;
          background-size: 100% 100%;
          color: #fff;
        }
      }
      .right {
      width: 70%;
      height: 100%;
      .el-checkbox__input.is-checked .el-checkbox__inner {
        background: #00a1a8;
        border-color: #00a1a8;
      }

      .right_group2 {
        font-size: 14px;
        max-height: 549px;
        overflow: auto;
        padding: 0 0 10px 0;
      }
      .checkboxwrap {
        position: absolute;
        left: 5px;
        top: -2px;
        .el-checkbox__label {
          display: none;
        }
      }
    }
  }
</style>

```

### 左侧联动右侧

锚点树左侧目录点击后，右侧监听并进行滚动，下发时监听滚动的代码

```js
mounted() {
    this.$root.$on('fname2', (index) => {
    for (var i = 0; i < this.postilList.length; i++) {
        var tz = this.postilList[i]
        if (index === tz.fname) {
        let ele = document.getElementById(tz.id + 'pz')
        let height = ele.offsetTop - 30
        $('#checkboxGroup').animate({scrollTop: height}, 300)
        this.$store.commit('setCurrentClickTppz', this.postilList[i].id)
        break
        }
    }
    })
}
```

### 右侧联动左侧

通过class获取右侧滚动区域，给它加上滚动监听时间scroll和触发的方法，将滚动的高度赋值并回传给左侧锚点树

```js
<mds2 :array="PDF_SELECT" :activeSzxx="postilList" :scrollHeight2='scroll2'></mds2>

document.querySelector('.right_group2').addEventListener('scroll', this.scrollMenu)

scrollMenu() {
    this.scroll2 = Number(document.querySelector('.right_group2').scrollTop)
    console.log(this.scroll2)
}
```
